<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Portal | MiraG</title>
    <link rel="icon" type="image/png" href="M.PNG">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SB_URL = "https://mchvarjggpjqmbjwpdaa.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jaHZhcmpnZ3BqcW1iandwZGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTQ2ODYsImV4cCI6MjA4NTU3MDY4Nn0.FakVUL6FS3pO_yTid3X-QX7L2JF7XlvM1FxSw1FdtZI";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    </script>
    <style>
        :root { --gold: #c5a059; --dark: #0a0a0a; --bg: #f4f4f4; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); padding-bottom: 50px; }
        .header { background: var(--dark); color: white; padding: 30px 20px; text-align: center; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative; }
        .logout-link { position: absolute; top: 15px; right: 20px; color: var(--gold); font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .section { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .section h3 { color: var(--gold); margin-bottom: 15px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; border-radius: 12px; font-size: 0.85rem; background: #fafafa; }
        .pass-container { position: relative; width: 100%; }
        .toggle-pass { position: absolute; right: 15px; top: 14px; cursor: pointer; font-size: 0.65rem; color: var(--gold); font-weight: 700; }
        .btn-gold { width: 100%; background: var(--gold); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-gold:disabled { background: #ccc; }
        .job-card { background: white; margin-bottom: 12px; padding: 15px; border-radius: 18px; border: 1px solid #f0f0f0; }
        .tag { background: rgba(197, 160, 89, 0.1); color: var(--gold); font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 8px; }
        .contact-box { margin-top: 12px; padding: 12px; background: #fdfaf4; border: 1px dashed var(--gold); border-radius: 12px; }
        .drawer-btn { width: 100%; background: #eee; border: none; padding: 10px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; color: #666; cursor: pointer; margin-top: 10px; }
        /* Style for Job Description */
        .desc-box { display: none; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 0.75rem; color: #444; line-height: 1.4; border-left: 2px solid var(--gold); }
        #history-list { display: none; margin-top: 15px; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body onload="checkAutoLogin()">

<div id="login-screen">
    <div class="section" style="width: 90%; max-width: 350px; text-align: center;">
        <h3 style="margin-bottom:20px;">Worker Login</h3>
        <input type="email" id="l-email" placeholder="Email">
        <div class="pass-container">
            <input type="password" id="l-pass" placeholder="Password">
            <span class="toggle-pass" onclick="toggleWorkerPass()">SHOW</span>
        </div>
        <button class="btn-gold" id="login-btn" onclick="login()">ENTER</button>
        <p style="margin-top: 15px; font-size: 0.7rem; color: #666;">
            Forgot password? 
            <span onclick="resetPassword()" style="color: var(--gold); cursor: pointer; font-weight: 700; text-decoration: underline;">
                Reset via Email
            </span>
        </p>
    </div>
</div>

<div class="header">
    <div class="logout-link" onclick="logout()">Logout</div>
    <h1 id="welcome" style="font-size: 1.4rem; color: var(--gold);">MiraG Worker</h1>
    <p style="font-size: 0.7rem; opacity: 0.8;">Find your next opportunity.</p>
</div>

<div class="section">
    <h3>My Profile</h3>
    <input type="text" id="w-name" placeholder="Full Name">
    <input type="text" id="w-phone" placeholder="Phone Number">
    <input type="file" id="w-cv" style="font-size: 0.7rem; border:none; background:none;">
    <button class="btn-gold" onclick="saveProfile()" style="padding:10px; font-size:0.8rem;">SAVE PROFILE</button>
</div>

<div class="section">
    <h3>Available Jobs</h3>
    <div id="feed">Loading...</div>
</div>

<div class="section">
    <h3>Applied History</h3>
    <button class="drawer-btn" onclick="toggleDrawer()">VIEW MY APPLICATIONS</button>
    <div id="history-list"></div>
</div>

<script>
    let cvUrl = "";

    // 1. Feature: Auto Login / Credential Saving
    async function checkAutoLogin() {
        const savedEmail = localStorage.getItem('mirag_email');
        const savedPass = localStorage.getItem('mirag_pass');
        
        if (savedEmail && savedPass) {
            document.getElementById('l-email').value = savedEmail;
            document.getElementById('l-pass').value = savedPass;
            login(); // Automatically attempts login
        }
    }

    function toggleWorkerPass() {
        const passIn = document.getElementById('l-pass');
        const btn = document.querySelector('.toggle-pass');
        if (passIn.type === "password") {
            passIn.type = "text";
            btn.innerText = "HIDE";
        } else {
            passIn.type = "password";
            btn.innerText = "SHOW";
        }
    }

    async function login() {
        const email = document.getElementById('l-email').value;
        const pass = document.getElementById('l-pass').value;
        const btn = document.getElementById('login-btn');
        
        btn.disabled = true;
        btn.innerText = "LOGGING IN...";

        const { error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: pass
        });

        if (error) {
            alert(error.message);
            btn.disabled = false;
            btn.innerText = "ENTER";
            localStorage.removeItem('mirag_pass'); // Clear bad password
        } else {
            // Save credentials for next time
            localStorage.setItem('mirag_email', email);
            localStorage.setItem('mirag_pass', pass);
            
            document.getElementById('login-screen').style.display = 'none';
            start();
        }
    }

    async function start() {
        await loadProfile();
        await refresh();
    }

    async function saveProfile() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const file = document.getElementById('w-cv').files[0];
        if (file) {
            const path = `cv_${user.id}_${Date.now()}`;
            await supabaseClient.storage.from('cvs').upload(path, file);
            const { data } = supabaseClient.storage.from('cvs').getPublicUrl(path);
            cvUrl = data.publicUrl;
        }
        await supabaseClient.from('worker_profiles').upsert({
            id: user.id, full_name: document.getElementById('w-name').value,
            phone: document.getElementById('w-phone').value, cv_url: cvUrl
        });
        alert("Profile Ready!");
    }

    async function loadProfile() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data } = await supabaseClient.from('worker_profiles').select('*').eq('id', user.id).single();
        if (data) {
            document.getElementById('w-name').value = data.full_name || "";
            document.getElementById('w-phone').value = data.phone || "";
            cvUrl = data.cv_url || "";
            document.getElementById('welcome').innerText = "Hello, " + (data.full_name || "Worker");
        }
    }

    // 2. Feature: Job Description Visibility
    async function refresh() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data: jobs } = await supabaseClient.from('jobs').select('*').order('created_at', {ascending: false});
        const { data: apps } = await supabaseClient.from('applications').select('*, jobs(*)').eq('worker_id', user.id);
        const appliedIds = apps ? apps.map(a => a.job_id) : [];

        const open = jobs ? jobs.filter(j => !appliedIds.includes(j.id)) : [];
        document.getElementById('feed').innerHTML = open.length ? open.map(j => `
            <div class="job-card">
                <span class="tag">${j.category}</span>
                <h4 style="margin:10px 0 5px;">${j.position}</h4>
                <p style="font-size:0.75rem; color:#666; margin-bottom:5px;">üí∞ ${j.salary} | üè¢ ${j.company_name || 'Employer'}</p>
                
                <span style="font-size:0.65rem; color:var(--gold); font-weight:700; cursor:pointer; text-decoration:underline;" 
                      onclick="toggleDesc('${j.id}')">VIEW DETAILS & DESCRIPTION</span>
                
                <div id="desc-${j.id}" class="desc-box">
                    <strong>Job Description:</strong><br>
                    ${j.description || 'No description provided.'}
                </div>

                <button class="btn-gold" style="margin-top:12px; height:35px; font-size:0.75rem;" onclick="apply('${j.id}')">APPLY NOW</button>
            </div>
        `).join('') : "<p style='font-size:0.75rem; color:#999;'>No new jobs available.</p>";

        document.getElementById('history-list').innerHTML = (apps && apps.length) ? apps.map(a => `
            <div class="job-card" style="border-left: 3px solid var(--gold);">
                <strong style="font-size:0.85rem;">${a.jobs?.position}</strong>
                <div class="contact-box">
                    <p style="font-size:0.7rem; font-weight:700; color:var(--gold); margin-bottom:5px;">BOSS CONTACT:</p>
                    <p style="font-size:0.75rem;">üë§ ${a.jobs?.contact_person || 'N/A'}</p>
                    <p style="font-size:0.75rem;">üìû <a href="tel:${a.jobs?.contact_phone}" style="color:var(--gold); font-weight:700;">${a.jobs?.contact_phone || 'N/A'}</a></p>
                    <p style="font-size:0.75rem;">‚úâÔ∏è ${a.jobs?.contact_email || 'N/A'}</p>
                </div>
                <div id="msg-${a.id}"></div>
                <span style="color:#ff4d4d; font-size:0.65rem; font-weight:800; cursor:pointer; display:block; margin-top:10px;" onclick="withdraw('${a.id}')">WITHDRAW APPLICATION</span>
            </div>
        `).join('') : "<p style='font-size:0.75rem; color:#999;'>No history yet.</p>";
        
        if (apps) apps.forEach(a => loadMsg(a.id));
    }

    function toggleDesc(id) {
        const el = document.getElementById(`desc-${id}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    async function loadMsg(appId) {
        const { data } = await supabaseClient.from('comments').select('message').eq('applicant_id', appId).limit(1);
        if (data && data.length > 0) {
            document.getElementById(`msg-${appId}`).innerHTML = `<div style="background:#fff9e6; padding:10px; border-radius:8px; margin-top:10px; font-size:0.7rem;"><strong>Boss Message:</strong> ${data[0].message}</div>`;
        }
    }

    async function apply(jobId) {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const name = document.getElementById('w-name').value;
        if (!name || !cvUrl) return alert("Save profile and upload CV first!");
        
        await supabaseClient.from('applications').insert([{
            job_id: jobId, worker_id: user.id, worker_name: name,
            worker_contact: document.getElementById('w-phone').value, cv_url: cvUrl
        }]);
        refresh();
    }

    async function withdraw(appId) {
        if (confirm("Withdraw this?")) {
            await supabaseClient.from('applications').delete().eq('id', appId);
            refresh();
        }
    }

    function toggleDrawer() {
        const h = document.getElementById('history-list');
        h.style.display = h.style.display === 'block' ? 'none' : 'block';
    }

    function logout() {
        localStorage.removeItem('mirag_pass'); // Only remove password on manual logout
        supabaseClient.auth.signOut();
        window.location.href = "index.html";
    }

    async function resetPassword() {
        const email = prompt("Enter your registered email address to receive a reset link:");
        if (!email) return;
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href,
        });
        if (error) alert("Error: " + error.message);
        else alert("Success! Check your email (and spam folder) for the password reset link.");
    }

    supabaseClient.auth.onAuthStateChange(async (event, session) => {
        if (event === "PASSWORD_RECOVERY") {
            const newPassword = prompt("Set your new secure password:");
            if (newPassword) {
                const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
                if (error) alert("Error: " + error.message);
                else alert("Password updated! You can now log in with your new password.");
            }
        }
    });
</script>
</body>
</html>