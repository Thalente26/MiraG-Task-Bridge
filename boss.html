<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="dns-prefetch" href="https://mchvarjggpjqmbjwpdaa.supabase.co">
    <title>Employer Dashboard | MiraG</title>
    <link rel="icon" type="image/png" href="M.PNG">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SB_URL = "https://mchvarjggpjqmbjwpdaa.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jaHZhcmpnZ3BqcW1iandwZGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTQ2ODYsImV4cCI6MjA4NTU3MDY4Nn0.FakVUL6FS3pO_yTid3X-QX7L2JF7XlvM1FxSw1FdtZI";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    </script>
    <style>
        :root { --gold: #c5a059; --dark: #0a0a0a; --bg: #f4f4f4; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); padding: 20px; padding-top: 80px; }
        .nav-bar { position: fixed; top: 0; left: 0; width: 100%; background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logout-btn { border: 1px solid var(--gold); color: var(--gold); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 0.7rem; }
        .grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 850px) { .grid { grid-template-columns: 1fr; } }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h3 { color: var(--gold); margin-bottom: 20px; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; font-size: 0.85rem; }
        
        .pass-container { position: relative; width: 100%; }
        .toggle-pass { 
            position: absolute; right: 12px; top: 14px; 
            cursor: pointer; font-size: 0.7rem; color: var(--gold); 
            font-weight: 700; 
        }

        .btn-gold { width: 100%; background: var(--gold); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer; }
        .job-item { padding: 15px; border: 1px solid #f0f0f0; border-radius: 12px; margin-bottom: 10px; position: relative; background: #fff; }
        .del-btn { color: #ff4d4d; position: absolute; right: 15px; top: 15px; font-size: 0.7rem; cursor: pointer; font-weight: 700; border: 1px solid #ff4d4d; padding: 2px 6px; border-radius: 5px; }
        .app-box { border-left: 4px solid var(--gold); padding: 15px; background: #fafafa; border-radius: 8px; margin-top: 10px; }
        #dashboard { display: none; }
    </style>
</head>
<body onload="checkAutoLogin()"> <div class="nav-bar">
        <img src="M.PNG" height="30" loading="lazy">
        <div style="display:flex; align-items:center; gap:15px;">
            <span id="user-display" style="font-size:0.75rem; color:var(--gold); font-weight: 600;"></span>
            <div class="logout-btn" onclick="logout()">LOGOUT</div>
        </div>
    </div>

    <div id="auth-section" style="display: flex; justify-content: center; padding: 50px 20px;">
        <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
            <h3>Employer Login</h3>
            <input type="email" id="login-email" placeholder="Email Address">
            <div class="pass-container">
                <input type="password" id="login-pass" placeholder="Password">
                <span class="toggle-pass" onclick="togglePassword()">SHOW</span>
            </div>
            <button class="btn-gold" id="login-btn" onclick="handleLogin()">LOGIN</button>
            <p style="margin-top: 15px; font-size: 0.7rem; color: #666;">
                Forgot password? 
                <span onclick="resetPassword()" style="color: var(--gold); cursor: pointer; font-weight: 700; text-decoration: underline;">
                    Reset via Email
                </span>
            </p>
        </div>
    </div>

    <div id="dashboard">
        <div class="grid">
            <div>
                <div class="card">
                    <h3>Company Profile</h3>
                    <input type="text" id="c-name" placeholder="Company Name">
                    <input type="text" id="c-person" placeholder="Contact Person">
                    <input type="text" id="c-addr" placeholder="Business Address">
                    <input type="text" id="c-phone" placeholder="Phone Number for Workers">
                    <input type="text" id="c-email" placeholder="Contact Email">
                    <button class="btn-gold" onclick="saveProfile()">SAVE CONTACT INFO</button>
                </div>

                <div class="card">
                    <h3>Post New Job</h3>
                    <input type="text" id="j-pos" placeholder="Job Title">
                    <select id="j-cat">
                        <option>Cleaner</option>
                        <option>Gardener</option>
                        <option>Nanny</option>
                        <option>Driver</option>
                        <option>Security</option>
                        <option>Domestic workers</option>
                        <option>Pet Sitters</option>
                        <option>Casual labourer</option>
                        <option>Childcare</option>
                        <option>Elderly Care</option>
                        <option>Waiters</option>
                        <option>Function car guards</option>
                        <option>Kids intertainers</option>
                        <option>Other</option>
                    </select>
                    <input type="text" id="j-sal" placeholder="Salary (e.g. R6500 pm)">
                    <textarea id="j-desc" rows="3" placeholder="Job Requirements & Description..."></textarea>
                    <button class="btn-gold" onclick="postJob()">POST JOB</button>
                </div>
            </div>

            <div>
                <div class="card">
                    <h3>Active Postings</h3>
                    <div id="job-list"></div>
                </div>
                <div class="card">
                    <h3 id="app-title">Applicants</h3>
                    <div id="app-list">Select a job to see who applied.</div>
                </div>
            </div>
        </div>
    </div>

<script>
    // FEATURE: Auto-Login Check
    async function checkAutoLogin() {
        const savedEmail = localStorage.getItem('mirag_boss_email');
        const savedPass = localStorage.getItem('mirag_boss_pass');
        if (savedEmail && savedPass) {
            document.getElementById('login-email').value = savedEmail;
            document.getElementById('login-pass').value = savedPass;
            handleLogin(); 
        }
    }

    function togglePassword() {
        const passInput = document.getElementById('login-pass');
        const toggleBtn = document.querySelector('.toggle-pass');
        if (passInput.type === "password") {
            passInput.type = "text";
            toggleBtn.innerText = "HIDE";
        } else {
            passInput.type = "password";
            toggleBtn.innerText = "SHOW";
        }
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const btn = document.getElementById('login-btn');

        if (btn) btn.innerText = "LOGGING IN...";

        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: pass
        });

        if (error) {
            alert(error.message);
            if (btn) btn.innerText = "LOGIN";
            localStorage.removeItem('mirag_boss_pass'); // Clear if password changed/wrong
        } else {
            // SUCCESS: Save Credentials
            localStorage.setItem('mirag_boss_email', email);
            localStorage.setItem('mirag_boss_pass', pass);

            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('user-display').innerText = data.user.email;
            loadProfile();
            loadJobs();
        }
    }

    async function saveProfile() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { error } = await supabaseClient.from('profiles').upsert({
            id: user.id, company_name: document.getElementById('c-name').value,
            contact_person: document.getElementById('c-person').value, address: document.getElementById('c-addr').value,
            phone: document.getElementById('c-phone').value, email_contact: document.getElementById('c-email').value
        });
        if (error) alert(error.message); else alert("Profile & Contacts Saved!");
    }

    async function loadProfile() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        if (data) {
            document.getElementById('c-name').value = data.company_name || "";
            document.getElementById('c-person').value = data.contact_person || "";
            document.getElementById('c-addr').value = data.address || "";
            document.getElementById('c-phone').value = data.phone || "";
            document.getElementById('c-email').value = data.email_contact || "";
        }
    }

    async function postJob() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { error } = await supabaseClient.from('jobs').insert([{
            employer_id: user.id, 
            position: document.getElementById('j-pos').value,
            category: document.getElementById('j-cat').value, 
            salary: document.getElementById('j-sal').value,
            description: document.getElementById('j-desc').value, // This saves the text for workers
            company_name: document.getElementById('c-name').value,
            location: document.getElementById('c-addr').value, 
            contact_person: document.getElementById('c-person').value,
            contact_phone: document.getElementById('c-phone').value, 
            contact_email: document.getElementById('c-email').value
        }]);
        if (error) alert(error.message); else { alert("Job is Live!"); loadJobs(); }
    }

    async function loadJobs() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data, error } = await supabaseClient.from('jobs').select('*').eq('employer_id', user.id).order('created_at', {ascending: false});
        if (error) console.error(error);
        document.getElementById('job-list').innerHTML = (data && data.length) ? data.map(j => `
            <div class="job-item">
                <span class="del-btn" onclick="deleteJob('${j.id}')">DELETE</span>
                <strong>${j.position}</strong><br><small>${j.salary} | ${j.location}</small><br>
                <button onclick="loadApps('${j.id}', '${j.position}')" style="margin-top:10px; background:none; border:none; color:var(--gold); font-weight:700; cursor:pointer; font-size:0.7rem;">VIEW APPLICANTS</button>
            </div>
        `).join('') : "No active jobs.";
    }

    async function deleteJob(id) {
        if (confirm("Delete this job? All associated applications will be wiped.")) {
            await supabaseClient.from('jobs').delete().eq('id', id);
            loadJobs();
            document.getElementById('app-list').innerHTML = "Select a job to see applicants.";
        }
    }

    async function loadApps(jobId, title) {
        const { data } = await supabaseClient.from('applications').select('*').eq('job_id', jobId);
        document.getElementById('app-title').innerText = `Applicants: ${title}`;
        document.getElementById('app-list').innerHTML = (data && data.length) ? data.map(a => `
            <div class="app-box">
                <strong>${a.worker_name}</strong> <a href="${a.cv_url}" target="_blank" style="float:right; color:var(--gold); font-size:0.7rem; font-weight:bold;">VIEW CV</a><br>
                <small>Worker Contact: ${a.worker_contact}</small>
                <textarea id="msg-${a.id}" style="margin-top:10px;" placeholder="Message for applicant..."></textarea>
                <button class="btn-gold" style="padding:8px; font-size:0.7rem;" onclick="sendComment('${a.id}')">SEND COMMENT</button>
            </div>
        `).join('') : "No applicants for this role yet.";
    }

    async function sendComment(appId) {
        const msg = document.getElementById(`msg-${appId}`).value;
        await supabaseClient.from('comments').insert([{ applicant_id: appId, message: msg }]);
        alert("Comment sent to worker portal.");
    }

    function logout() {
        localStorage.removeItem('mirag_boss_pass'); // Clear password on manual logout
        supabaseClient.auth.signOut();
        window.location.href = "index.html";
    }

    async function resetPassword() {
        const email = prompt("Enter your registered email address to receive a reset link:");
        if (!email) return;
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href,
        });
        if (error) alert("Error: " + error.message);
        else alert("Success! Check your email (and spam folder) for the password reset link.");
    }

    supabaseClient.auth.onAuthStateChange(async (event, session) => {
        if (event === "PASSWORD_RECOVERY") {
            const newPassword = prompt("Set your new secure password:");
            if (newPassword) {
                const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
                if (error) alert("Error: " + error.message);
                else alert("Password updated! You can now log in with your new password.");
            }
        }
    });
</script>
</body>
</html>